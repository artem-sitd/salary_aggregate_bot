# salary_aggregate_bot
Асинхронный бот, агрегирующий зарплаты за указанный период, 
по указанному типу группировки. <b>Стек:</b> Python3, Asyncio, MongoDB, 
любая асинхронная библиотека для телеграм бота

<h3>Техническое задание:</h3>
Вашей задачей будет написание алгоритма агрегации статистических 
данных о зарплатах сотрудников компании по временным промежуткам.
На обычном языке пример задачи выглядит следующим образом: 
“Необходимо посчитать суммы всех выплат с {28.02.2022} по {31.03.2022}, единица группировки - {день}”.

> Ваш алгоритм должен принимать на вход:
1.	Дату и время старта агрегации в ISO формате (далее dt_from)
2.	Дату и время окончания агрегации в ISO формате (далее dt_upto)
3.	Тип агрегации (далее group_type). Типы агрегации могут быть следующие: hour, day, month.
То есть группировка всех данных за час, день, неделю, месяц.

Пример входных данных:
```
{
"dt_from":"2022-09-01T00:00:00",
"dt_upto":"2022-12-31T23:59:00",
"group_type":"month"
}
```

> Комментарий к входным данным: 

вам необходимо агрегировать выплаты с 1 сентября 2022 года по 31 декабря 2022 года,
тип агрегации по месяцу

> На выходе ваш алгоритм формирует ответ содержащий:
1.	Агрегированный массив данных (далее dataset)
2.	Подписи к значениям агрегированного массива данных в ISO формате (далее labels)

Пример ответа:
``` 
{"dataset": [5906586, 5515874, 5889803, 6092634], 
"labels": ["2022-09-01T00:00:00", "2022-10-01T00:00:00", "2022-11-01T00:00:00", "2022-12-01T00:00:00"]}
```

> Комментарий к ответу:

в нулевом элементе датасета содержится сумма всех выплат за сентябрь, 
в первом элементе сумма всех выплат за октябрь и т.д. В лейблах подписи соответственно элементам датасета.

<h3>Тесты:</h3>
Использую  pytest, три тестовых случая (tests/test_routes.py). Для группировок по месяцу, дню и часу (test/fixt.py)

<img height="150" src="https://github.com/artem-sitd/salary_aggregate_bot/assets/22573129/f549a598-fa6c-44bf-9557-1bc8b899e5b4">

<h3>Вебхуки</h3>
Для локальной разработки потребуется имитация публичного ip, в связи с тем, 
что сервер телеграмма отправляет запросы на публичный сервер. Для этого использовал ngrok

<h3> Установка </h3>

> клонирование репозитория
`git clone https://github.com/artem-sitd/salary_aggregate_bot.git`

> открываем терминал и переходим в папку, для этого пишем
`cd salary_aggregate_bot`

<h4>Настраиваем вебхуки с ngrok
на windows:</h4>

1. Переходим сюда: `https://dashboard.ngrok.com/get-started/setup/windows`
потребуется аутентификация (кто из РФ используйте VPN)
2. Следующую страницу можно пропустить, далее заполнять не важно как

<img height="300" src="https://github.com/artem-sitd/salary_aggregate_bot/assets/22573129/ca0503db-4fe2-4e5c-b8a2-0e4066fda402">

4. скачиваем ngrok и включаем, далее копируем конфиг (п. 4 на картинке), и вставляем в терминал ngrok,
далее копируем (п 5 на картинке) и вставляем в терминал ngrok, предварительно исправив на порт 8000
4. Ваш терминал ngrok должен показывать нечто похожее на это:

<img height="200" src="https://github.com/artem-sitd/salary_aggregate_bot/assets/22573129/27b5218e-2873-45b1-b041-803e746849c3">

Выделенный фрагмент необходимо скопировать и вставить в ваш .env в переменную `WEBHOOK_URL=`. <b>ВНИМАНИЕ! В КОНЕЦ URL добавьте `"/"`</b>

<h4>Настраиваем локально вебхуки с ngrok:
на linux (ubuntu):</h4>
1. Переходим сюда `https://ngrok.com/download` авторизуемся
2. Далее переходим сюда и копируем `https://dashboard.ngrok.com/get-started/setup/docker`


<img height="300" src="https://github.com/artem-sitd/salary_aggregate_bot/assets/22573129/179ac79f-3c45-4c5e-a9fd-410d3af597fc">


3. В новом терминале вводим эту команду

<img height="200" src="https://github.com/artem-sitd/salary_aggregate_bot/assets/22573129/e979d03b-aba9-4683-9735-6f1bf1437604">

Выделенный фрагмент необходимо вставить в .env.docker в переменную `WEBHOOK_URL`. <b>Внимание! В КОНЦЕ URL ДОБАВЬТЕ /.</b>

<h4>Без докера:</h4>

Клонируем реп, вставили апи токен бота, ngrok в .env. Установили зависимости, mongodb, создали базу "salary", коллекцию "salaries".
Пишем в терминал `uvicorn app.main:app --reload`. Пользуемся ботом

<h4>С докером:</h4>

> Далее вне зависимости от системы: Настройку с получением токена бота опустим, его необходимо вставить в ваш `.env.docker` в переменную `TELEGRAM_API_TOKEN`

Возвращаемся в терминал с проектом, вводим команду:
`docker-compose up --build`
После успешной сборки всех контейнеров -> в другом терминале пишем:
`docker exec -it mongodb bash` ->
`mongorestore -d salary_db -c salaries /docker-entrypoint-initdb.d/data/sample_collection.bson`
Можно пользоваться ботом

Пока не решил проблему с автоматическим импортом документов в коллекцию. Хотя в докере указана команда порядка выполнения скриптов
